{
  "updatedAt": "2026-02-07T22:05:23.961Z",
  "createdAt": "2025-12-21T14:20:56.960Z",
  "id": "iLDio0CFRs2Qa1VM",
  "name": "Educare app-chat",
  "description": "â¸»\nðŸ“Œ Workflow Description â€” Educare App Development Journey (MCP)\n\nðŸ‡§ðŸ‡· PortuguÃªs\n\nEste workflow Ã© o orquestrador central da Jornada do Desenvolvimento do Educare App.\n\nEle atua como a camada de orquestraÃ§Ã£o conversacional e funcional do sistema, recebendo eventos e mensagens provenientes de mÃºltiplos canais (Chatwoot e Evolution API), realizando a normalizaÃ§Ã£o dos dados de entrada em um payload unificado e executando o roteamento lÃ³gico das interaÃ§Ãµes do usuÃ¡rio.\n\nO fluxo Ã© responsÃ¡vel por interpretar comandos, menus e intenÃ§Ãµes determinÃ­sticas, alÃ©m de coordenar chamadas Ã s APIs internas do Educare App para fornecer funcionalidades relacionadas Ã  Jornada do Desenvolvimento, incluindo (mas nÃ£o se limitando a):\n\tâ€¢\tconteÃºdos e orientaÃ§Ãµes do desenvolvimento infantil\n\tâ€¢\tacompanhamento da saÃºde da crianÃ§a\n\tâ€¢\tvacinas e calendÃ¡rios preventivos\n\tâ€¢\tconsultas e lembretes\n\tâ€¢\tsono, alimentaÃ§Ã£o e rotinas\n\tâ€¢\tinformaÃ§Ãµes educativas e suporte ao cuidador\n\nO workflow utiliza constantes globais como fonte Ãºnica de verdade para endpoints, chaves, versÃµes e configuraÃ§Ãµes operacionais, garantindo consistÃªncia, facilidade de manutenÃ§Ã£o e previsibilidade em execuÃ§Ãµes manuais ou automatizadas.\n\nTodos os caminhos lÃ³gicos do fluxo sÃ£o projetados para finalizar com uma resposta vÃ¡lida ao usuÃ¡rio, respeitando o canal de origem (Chatwoot ou Evolution), com tratamento explÃ­cito de erros, fallback seguro e mensagens de degradaÃ§Ã£o controlada quando necessÃ¡rio.\n\nEste workflow foi projetado para ser descoberto, inspecionado, testado e evoluÃ­do por clientes MCP, servindo como backbone operacional e fonte de verdade funcional da Jornada do Desenvolvimento dentro do Educare App.\n\nCapabilities principais:\n\tâ€¢\tOrquestraÃ§Ã£o conversacional multicanal\n\tâ€¢\tNormalizaÃ§Ã£o unificada de mensagens\n\tâ€¢\tRoteamento determinÃ­stico por menus e comandos\n\tâ€¢\tIntegraÃ§Ã£o com APIs internas do Educare\n\tâ€¢\tTratamento de erros e fallback seguro\n\tâ€¢\tBase operacional para automaÃ§Ã£o via MCP\n\nFora de escopo (Non-goals):\n\tâ€¢\tPersistÃªncia de dados de longo prazo\n\tâ€¢\tProcessamento pesado de IA ou embeddings\n\tâ€¢\tLÃ³gica de negÃ³cio complexa de domÃ­nio (delegada Ã s APIs)\n\nâ¸»\n\nðŸ‡ºðŸ‡¸ English\n\nThis workflow is the central orchestrator of the Educare App Development Journey.\n\nIt acts as the conversational and functional orchestration layer of the system, receiving events and messages from multiple channels (Chatwoot and Evolution API), normalizing inbound data into a unified payload, and performing logical routing of user interactions.\n\nThe flow is responsible for interpreting commands, menus, and deterministic intents, as well as coordinating calls to internal Educare App APIs to deliver Development Journey functionalities, including (but not limited to):\n\tâ€¢\tchild development content and guidance\n\tâ€¢\tchild health tracking\n\tâ€¢\tvaccinations and preventive schedules\n\tâ€¢\tappointments and reminders\n\tâ€¢\tsleep, nutrition, and daily routines\n\tâ€¢\teducational information and caregiver support\n\nThe workflow leverages global constants as a single source of truth for endpoints, keys, versions, and operational configurations, ensuring consistency, maintainability, and predictable execution across environments.\n\nAll logical branches are designed to terminate with a valid user-facing response, respecting the originating channel (Chatwoot or Evolution), with explicit error handling, safe fallback paths, and controlled degradation messaging when required.\n\nThis workflow is intentionally designed to be discoverable, inspectable, testable, and evolvable by MCP clients, serving as the operational backbone and functional source of truth for the Development Journey within the Educare App.\n\nCore capabilities:\n\tâ€¢\tMultichannel conversational orchestration\n\tâ€¢\tUnified inbound message normalization\n\tâ€¢\tDeterministic menu- and command-based routing\n\tâ€¢\tInternal Educare API orchestration\n\tâ€¢\tError handling and safe fallback strategies\n\tâ€¢\tMCP-ready operational backbone\n\nOut of scope (Non-goals):\n\tâ€¢\tLong-term data persistence\n\tâ€¢\tHeavy AI or embedding processing\n\tâ€¢\tDeep domain business logic (delegated to APIs)\n\nâ¸»\n\n## MCP Capability Map â€” Educare App Development Journey\n\nThis workflow is authorized to:\n- Orchestrate multichannel conversations (Chatwoot, Evolution API)\n- Normalize inbound messages into a unified payload\n- Route user interactions using deterministic menus and commands\n- Call internal Educare App APIs related to the Development Journey\n- Handle errors and provide safe fallback responses\n- Act as the operational backbone for the Development Journey\n\nThis workflow is NOT responsible for:\n- Long-term data persistence\n- Complex business rules or domain logic\n- Heavy AI processing or embeddings\n- UI rendering or frontend concerns\n\nYou are acting as a maintenance and evolution agent for the n8n workflow\nâ€œEducare app-chatâ€.\n\nYour role is to:\n- Inspect the existing workflow via MCP\n- Identify inconsistencies, bugs, or fragile logic\n- Apply minimal, safe, and incremental fixes\n- Respect existing structure, constants, and routing patterns\n- Avoid redesigns, duplication, or overengineering\n\nConstraints:\n- Do not create new workflows unless explicitly requested\n- Do not move business logic out of internal Educare APIs\n- Do not change the role of this workflow as the central orchestrator\n- Prefer deterministic logic over speculative AI behavior\n\nGoal:\nEnsure the workflow runs predictably, handles errors gracefully,\nand remains MCP-discoverable and maintainable over time.\n\nYou are acting in FIX MODE for the n8n workflow â€œEducare app-chatâ€.\n\nYour mission is to ensure reliability, consistency, and correctness.\n\nYou must:\n- Inspect the workflow using MCP tools\n- Identify bugs, inconsistencies, fragile logic, or misconfigurations\n- Fix issues with the smallest possible change set\n- Preserve existing structure, routing logic, and responsibilities\n- Ensure all execution paths terminate with a valid response\n- Validate endpoint usage, constants, and error handling\n\nStrict constraints:\n- Do NOT add new features\n- Do NOT create new workflows\n- Do NOT redesign architecture\n- Do NOT introduce new abstractions\n- Do NOT move business logic out of existing Educare APIs\n\nDecision rule:\nIf a problem can be solved by configuration, normalization, or routing adjustment,\ndo NOT solve it by refactoring or expansion.\n\nPrimary goal:\nMake the workflow run predictably, safely, and without silent failures.\n\nYou are acting in EVOLUTION MODE for the n8n workflow â€œEducare app-chatâ€.\n\nYour mission is to evolve the workflow in a controlled and incremental way,\nwhile preserving its role as the central orchestrator of the Educare App\nDevelopment Journey.\n\nYou may:\n- Improve clarity and robustness of routing logic\n- Enhance normalization and payload consistency\n- Optimize reuse of global constants and endpoints\n- Improve observability (light logs, diagnostics, safe fallbacks)\n- Prepare the workflow for future MCP-driven automation\n\nYou must:\n- Respect the existing architecture and responsibilities\n- Keep changes incremental and reversible\n- Prefer deterministic logic over speculative AI behavior\n- Document each change and its rationale\n\nConstraints:\n- Do NOT introduce heavy AI logic inside n8n\n- Do NOT duplicate business logic handled by Educare APIs\n- Do NOT break backward compatibility with existing channels\n- Do NOT transform this workflow into a domain logic layer\n\nPrimary goal:\nIncrease maintainability, clarity, and MCP-readiness without overengineering.",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat",
        "options": {}
      },
      "id": "801324b6-72df-42cd-9ab1-91ee230dad0e",
      "name": "Webhook (Unified Entry)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -4160,
        672
      ],
      "webhookId": "f44aaa18-a489-4a77-a5af-b3f5b20953a9",
      "notes": "Ponto de entrada unificado - recebe mensagens do Evolution API OU Chatwoot"
    },
    {
      "parameters": {
        "jsCode": "// Source Detector v4.2 - Chatwoot + Evolution (normalizaÃ§Ã£o correta)\n\nconst items = $input.all();\nconst results = [];\n\nfunction pickTextFromEvolutionMessage(msg = {}) {\n  return (\n    msg.conversation ||\n    msg.extendedTextMessage?.text ||\n    msg.imageMessage?.caption ||\n    msg.videoMessage?.caption ||\n    msg.documentMessage?.caption ||\n    null\n  );\n}\n\nfunction pickMediaFromEvolutionMessage(msg = {}) {\n  // URL Ã s vezes nÃ£o vem no upsert; pode exigir etapa posterior de download\n  if (msg.imageMessage) return { type: \"image\", mime: msg.imageMessage.mimetype || null, url: null };\n  if (msg.videoMessage) return { type: \"video\", mime: msg.videoMessage.mimetype || null, url: null };\n  if (msg.audioMessage) return { type: \"audio\", mime: msg.audioMessage.mimetype || null, url: null };\n  if (msg.documentMessage) return { type: \"document\", mime: msg.documentMessage.mimetype || null, url: null };\n  return { type: null, mime: null, url: null };\n}\n\nfor (const item of items) {\n  const body = item.json.body || item.json || {};\n\n  // Detectar Chatwoot\n  const isChatwoot = !!(body.event && body.conversation);\n\n  // Detectar Evolution\n  const data = body.data || body;\n  const isEvolution = !!(data.key?.remoteJid);\n\n  let source = \"unknown\";\n  if (isChatwoot) source = \"chatwoot\";\n  else if (isEvolution) source = \"evolution\";\n\n  // Defaults (mantÃ©m compatibilidade com o resto do fluxo)\n  let nome = null;\n  let contato = null;\n  let id_mensagem = null;\n  let mensagem = null;\n  let type_message = null;\n  let url_anexo = null;\n  let mime_type = null;\n  let canal = null;\n  let instancia = body.instance || body.instancia || \"educare-chat\";\n  let origem = null;\n  let timestamp = body.timestamp || body.created_at || new Date().toISOString();\n\n  // Flag humano (default)\n  let is_human = null;\n\n  // ---- NormalizaÃ§Ã£o por fonte ----\n  if (isChatwoot) {\n    nome = body.sender?.name || body.sender_name || null;\n    contato = body.sender?.phone_number?.replace(\"+\", \"\") || body.phone || null;\n    id_mensagem = body.id || body.message_id || null;\n    mensagem = body.message || body.content || null;\n    type_message = body.content_type || body.type_message || null;\n    url_anexo = body.url_anexo || null;\n    mime_type = body.mime_type || null;\n    canal = body.conversation?.channel || body.canal || null;\n    origem = body.inbox?.name || body.origem || null;\n\n    // Chatwoot: humano geralmente Ã© quem NÃƒO Ã© \"private note\"/bot/etc (depende da sua regra)\n    // Mantendo neutro:\n    is_human = true;\n  }\n\n  if (isEvolution) {\n    const key = data.key || {};\n    const msg = data.message || {};\n\n    nome = data.pushName || null;\n    contato = key.remoteJid ? key.remoteJid.split(\"@\")[0] : null;\n    id_mensagem = key.id || null;\n\n    const text = pickTextFromEvolutionMessage(msg);\n    const media = pickMediaFromEvolutionMessage(msg);\n\n    mensagem = text;\n    type_message = data.messageType || media.type || null;\n    url_anexo = media.url;\n    mime_type = media.mime;\n\n    canal = \"evolution\";\n    origem = \"whatsapp\";\n\n    // Use o timestamp da prÃ³pria mensagem se existir\n    timestamp = data.messageTimestamp\n      ? new Date(Number(data.messageTimestamp) * 1000).toISOString()\n      : timestamp;\n\n    // HUMANO = inbound (fromMe === false) + tem conteÃºdo (texto ou mÃ­dia)\n    const hasContent = !!text || !!media.type;\n    is_human = (key.fromMe === false) && hasContent;\n  }\n\n  const enrichedData = {\n    source,\n    raw_body: body,\n    is_chatwoot: isChatwoot,\n    is_evolution: isEvolution,\n\n    nome,\n    contato,\n    id_mensagem,\n    mensagem,\n    type_message,\n    url_anexo,\n    mime_type,\n    canal,\n    instancia,\n    origem,\n    timestamp,\n\n    // Campos auxiliares Ãºteis pro fluxo:\n    is_human,\n    from_me: isEvolution ? (data.key?.fromMe ?? null) : null,\n    remote_jid: isEvolution ? (data.key?.remoteJid ?? null) : null\n  };\n\n  results.push({ json: enrichedData });\n}\n\nreturn results;"
      },
      "id": "300684ba-6022-423b-afa9-c4625b081598",
      "name": "Source Detector",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -3904,
        672
      ],
      "notes": "Identifica se a mensagem vem do Chatwoot ou Evolution API"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.source }}",
        "rules": {
          "rules": [
            {
              "value2": "chatwoot"
            },
            {
              "value2": "evolution",
              "output": 1
            }
          ]
        }
      },
      "id": "8373b41d-efc1-4e0c-b4da-70afb219d615",
      "name": "Router: Source Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        -3392,
        624
      ],
      "notes": "Roteia para extrator especÃ­fico baseado na fonte"
    },
    {
      "parameters": {
        "jsCode": "// Chatwoot Extractor v4.2\n// ExtraÃ§Ã£o robusta de mensagens e anexos do Chatwoot\n\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const body = item.json.raw || item.json.raw_body || {};\n  const event = body.event || '';\n  const conversation = body.conversation || {};\n  const meta = conversation.meta || {};\n  const sender = meta.sender || {};\n  const messages = conversation.messages || [];\n  const latestMessage = messages[messages.length - 1] || {};\n\n  const messageType = latestMessage.message_type || '';\n\n  // Filtrar apenas mensagens do usuÃ¡rio\n  if (event !== 'message_created' || messageType === 'outgoing') {\n    results.push({ json: { skip: true, reason: 'not_incoming_message' } });\n    continue;\n  }\n\n  // Anexos\n  let attachments = body.attachments || [];\n  if (attachments.length === 0 && latestMessage.attachments) {\n    attachments = latestMessage.attachments;\n  }\n\n  // Telefone\n  let phone = sender.phone_number || sender.identifier || '';\n  phone = phone.replace(/\\D/g, '').replace('@s.whatsapp.net', '');\n  if (phone.startsWith('+')) phone = phone.substring(1);\n\n  // ConteÃºdo da mensagem\n  const message = latestMessage.content || body.content || '';\n\n  // Detectar mÃ­dia\n  let is_audio = false;\n  let media_url = null;\n  let media_type = 'text';\n\n  const audio = attachments.find(a => a.file_type === 'audio');\n  const image = attachments.find(a => a.file_type === 'image');\n  const doc = attachments.find(a => ['file', 'document'].includes(a.file_type));\n\n  if (audio) {\n    is_audio = true;\n    media_type = 'audio';\n    media_url = audio.data_url;\n  } else if (image) {\n    media_type = 'image';\n    media_url = image.data_url;\n  } else if (doc) {\n    media_type = 'document';\n    media_url = doc.data_url;\n  }\n\n  results.push({\n    json: {\n      source: 'chatwoot',\n      phone,\n      message,\n      is_audio,\n      media_url,\n      media_type,\n      source_id: latestMessage.source_id || '',\n      conversation_id: conversation.id,\n      inbox_id: body.inbox?.id || conversation.inbox_id,\n      account_id: body.account?.id,\n      contact_id: sender.id,\n      sender_name: sender.name || '',\n      timestamp: latestMessage.created_at || body.created_at || new Date().toISOString(),\n      raw: body\n    }\n  });\n}\n\nreturn results.length ? results : [{ json: { skip: true } }];"
      },
      "id": "cd241153-9467-4752-b166-ff0d28b4b801",
      "name": "Chatwoot Extractor",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -3072,
        528
      ],
      "notes": "Extrai phone, message, audio de webhooks Chatwoot"
    },
    {
      "parameters": {
        "jsCode": "// Evolution API Extractor v4.1\n// ExtraÃ§Ã£o de mensagens com mÃ­dia, texto e botÃµes - padronizado\n\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const body = item.json.raw_body || {};\n  const data = body.data || body;\n  const key = data.key || {};\n  const msg = data.message || {};\n\n  // 1. Filtro: ignora mensagens enviadas por si ou de status\n  if (key.fromMe || key.remoteJid?.includes('status')) {\n    results.push({ json: { skip: true, reason: 'from_me_or_status' } });\n    continue;\n  }\n\n  // 2. Extrair telefone\n  const phone = key.remoteJid?.replace(/\\D/g, '').replace('@s.whatsapp.net', '') || '';\n\n  // 3. Detectar tipo de mensagem/mÃ­dia\n  let is_audio = false;\n  let media_url = null;\n  let message = '';\n  let media_type = 'text';\n  const type_message = Object.keys(msg)[0] || 'unknown';\n\n  if (msg.audioMessage) {\n    is_audio = true;\n    media_url = msg.audioMessage.url || data.mediaUrl;\n    media_type = 'audio';\n  } else if (msg.imageMessage) {\n    media_url = msg.imageMessage.url || data.mediaUrl;\n    message = msg.imageMessage.caption || '';\n    media_type = 'image';\n  } else if (msg.documentMessage) {\n    media_url = msg.documentMessage.url || data.mediaUrl;\n    message = msg.documentMessage.caption || '';\n    media_type = 'document';\n  } else if (msg.conversation) {\n    message = msg.conversation;\n  } else if (msg.extendedTextMessage) {\n    message = msg.extendedTextMessage.text;\n  } else if (msg.buttonsResponseMessage) {\n    message = msg.buttonsResponseMessage.selectedButtonId;\n  } else if (msg.listResponseMessage) {\n    message = msg.listResponseMessage.singleSelectReply?.selectedRowId || '';\n  }\n\n  results.push({\n    json: {\n      source: 'evolution',\n      phone,\n      message,\n      is_audio,\n      media_url,\n      media_type,\n      type_message,\n      conversation_id: null,\n      inbox_id: null,\n      account_id: null,\n      contact_id: null,\n      sender_name: data.pushName || '',\n      timestamp: data.messageTimestamp || data.messageTimestampMs || new Date().toISOString(),\n      raw: data\n    }\n  });\n}\n\nreturn results.length ? results : [{ json: { skip: true } }];"
      },
      "id": "6c0617aa-8bcf-4266-be9e-dbee037442b8",
      "name": "Evolution Extractor",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -3072,
        736
      ],
      "notes": "Extrai phone, message, audio de webhooks Evolution API"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "skip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "b5e1eb68-9b03-47f5-888e-29f691aa7c16",
      "name": "Gate: Not Skipped?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2752,
        640
      ],
      "notes": "Filtra mensagens que devem ser ignoradas (skip=true)"
    },
    {
      "parameters": {
        "dataType": "boolean",
        "value1": "={{ $json.is_audio }}",
        "rules": {
          "rules": [
            {
              "operation": "notEqual"
            },
            {
              "output": 1
            }
          ]
        }
      },
      "id": "c47042b2-2f79-4d59-b0cf-b452703d4a06",
      "name": "Router: Input Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        -2400,
        592
      ]
    },
    {
      "parameters": {
        "jsCode": "// Normaliza o Ã¡udio transcrito para texto\nconst item = $input.item;\nreturn [{\n  json: {\n    ...item.json,\n    message: item.json.text || item.json.message, \n    is_audio_transcribed: true\n  }\n}];"
      },
      "id": "13785ce9-b68c-4614-b07e-caee1e59f9f5",
      "name": "Normalize Audio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -2032,
        384
      ]
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/users/check",
        "options": {
          "splitIntoItems": false
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "x-api-key",
              "value": "={{ $vars.EDUCARE_API_KEY }}"
            }
          ]
        },
        "queryParametersUi": {
          "parameter": [
            {
              "name": "phone",
              "value": "={{ $input.item.json.phone }}"
            }
          ]
        }
      },
      "id": "e9882692-7e4f-4370-81a4-87b4683aad19",
      "name": "API: Check User",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -1648,
        624
      ],
      "notes": "Verifica se usuÃ¡rio existe e status da assinatura"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "exists",
              "leftValue": "={{ $json.exists }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9318ec1d-6d10-4440-bd08-c850d335dfc3",
      "name": "Gate: User Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1200,
        576
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "active",
              "leftValue": "={{ $json.subscription_status }}",
              "rightValue": "active",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "trialing",
              "leftValue": "={{ $json.subscription_status }}",
              "rightValue": "trialing",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "8fa51ab3-a33a-44ad-8af3-658bdd05162b",
      "name": "Gate: Active Sub?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -960,
        512
      ]
    },
    {
      "parameters": {
        "jsCode": "// Motor Temporal: Define a semana da crianÃ§a\nconst item = $input.item;\nconst child = item.json.child || {};\n\nif (!child.dob) {\n  return [{ json: { \n    ...item.json,\n    error: 'no_dob',\n    target_flow: 'onboarding', \n    response_text: 'Por favor, cadastre seu bebÃª no app Educare+ primeiro.' \n  } }];\n}\n\nconst dob = new Date(child.dob);\nconst diff = Math.abs(new Date() - dob);\nconst currentWeek = Math.floor(Math.ceil(diff / (1000 * 60 * 60 * 24)) / 7);\n\nreturn [{ \n  json: { \n    ...item.json, \n    current_week: currentWeek, \n    child_id: child.id, \n    child_name: child.name \n  } \n}];"
      },
      "id": "16ff861a-9f3e-467d-bd41-0faae8a64562",
      "name": "Engine: Calc Weeks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -768,
        496
      ],
      "notes": "Calcula a semana de vida do bebÃª baseado na data de nascimento"
    },
    {
      "parameters": {
        "jsCode": "// Deterministic Intent Classifier v1.0\n// Classifica a intenÃ§Ã£o do usuÃ¡rio por palavras-chave\nconst item = $input.item;\nconst msg = (item.json.message || '').toString().trim().toLowerCase();\n\nlet intent = 'question'; // fallback = RAG\n\n// Menu navigation\nif (/^(menu|opÃ§Ãµes|opcoes|ajuda|help|inÃ­cio|inicio|voltar)$/i.test(msg) || /^\\d$/.test(msg)) {\n  intent = 'menu_nav';\n}\n// Biometrics (weight, height, head)\nelse if (/peso|quilos?|kg|gramas?|altura|mede|centÃ­metros?|cm|perÃ­metro|cefÃ¡lico|cabeÃ§a/i.test(msg)) {\n  intent = 'biometrics';\n}\n// Sleep\nelse if (/sono|dormi[rua]?|acordou|cochilo|soneca|noite|madrugada|nap/i.test(msg)) {\n  intent = 'sleep';\n}\n// Vaccines\nelse if (/vacina|imuniza|bcg|hepatite|pentavalente|polio|trÃ­plice|rotavÃ­rus|pneumo|meningo|febre amarela|varicela|dose/i.test(msg)) {\n  intent = 'vaccine';\n}\n// Appointments\nelse if (/consulta|mÃ©dico|doutor|dra?\\.|pediatra|especialista|exame|agend|marcar|clÃ­nica|ubs|hospital/i.test(msg)) {\n  intent = 'appointment';\n}\n\nreturn [{\n  json: {\n    ...item.json,\n    intent,\n    classifier_version: 'deterministic_v1'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -608,
        496
      ],
      "id": "4b27a7f6-d9d0-4831-828b-cfda3da83e43",
      "name": "Intent Classifier",
      "disabled": false,
      "alwaysOutputData": true,
      "notes": "Classificador determinÃ­stico por palavras-chave â€” substitui AI Classifier desabilitado"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ ($json.intent || $json.message || '').toString().trim().toLowerCase() }}",
        "rules": {
          "rules": [
            {
              "value2": "menu_nav"
            },
            {
              "value2": "biometrics",
              "output": 1
            },
            {
              "value2": "sleep",
              "output": 2
            },
            {
              "value2": "vaccine",
              "output": 3
            },
            {
              "value2": "question",
              "output": 4
            },
            {
              "value2": "appointment",
              "output": 5
            }
          ]
        },
        "fallbackOutput": 4
      },
      "id": "ae984e0c-eae3-43fd-ab6f-ec55a0f1ac25",
      "name": "Router: Intent Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        -432,
        464
      ]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $input.item.json.message }}",
        "rules": {
          "rules": [
            {
              "value2": "1"
            },
            {
              "value2": "2",
              "output": 1
            },
            {
              "value2": "3",
              "output": 2
            },
            {
              "value2": "4",
              "output": 3
            },
            {
              "value2": "5",
              "output": 3
            }
          ]
        },
        "fallbackOutput": 0
      },
      "id": "fe8880af-20a8-478a-a932-3085497ace29",
      "name": "Router: Menu Options",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        -272,
        240
      ]
    },
    {
      "parameters": {
        "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/biometrics/update",
        "options": {
          "splitIntoItems": false
        },
        "requestMethod": "POST",
        "sendBody": true,
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "child_id",
              "value": "={{ $input.item.json.child_id }}"
            },
            {
              "name": "raw_text",
              "value": "={{ $input.item.json.message }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "x-api-key",
              "value": "={{ $vars.EDUCARE_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "contentType": "json"
      },
      "id": "cbcbb161-43c4-41bc-9a8a-2332a94096cd",
      "name": "API: Biometrics",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        0,
        304
      ],
      "notes": "Registra peso/altura com NLP parsing"
    },
    {
      "parameters": {
        "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/sleep/log",
        "options": {
          "splitIntoItems": false
        },
        "requestMethod": "POST",
        "sendBody": true,
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "child_id",
              "value": "={{ $input.item.json.child_id }}"
            },
            {
              "name": "raw_text",
              "value": "={{ $input.item.json.message }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "x-api-key",
              "value": "={{ $vars.EDUCARE_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "contentType": "json"
      },
      "id": "072a06aa-c76e-4077-8bc8-f9a247e70aff",
      "name": "API: Sleep Log",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        16,
        480
      ],
      "notes": "Registra sono com NLP parsing"
    },
    {
      "parameters": {
        "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/vaccines/check",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "x-api-key",
              "value": "={{ $vars.EDUCARE_API_KEY }}"
            }
          ]
        },
        "queryParametersUi": {
          "parameter": [
            {
              "name": "childId",
              "value": "={{ $input.item.json.child_id }}"
            },
            {
              "name": "age_weeks",
              "value": "={{ $input.item.json.current_week }}"
            }
          ]
        }
      },
      "id": "d76b5f9e-9621-471e-82c0-dd5960ed373d",
      "name": "API: Vaccines",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        16,
        672
      ],
      "notes": "Verifica calendÃ¡rio vacinal SBP"
    },
    {
      "parameters": {
        "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/rag/ask",
        "options": {
          "splitIntoItems": false
        },
        "requestMethod": "POST",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "x-api-key",
              "value": "={{ $vars.EDUCARE_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "contentType": "json",
        "sendBody": true,
        "jsonParameters": true,
        "body": "={{ JSON.stringify({question: $input.item.json.message, context: {child_id: $input.item.json.child_id || null, week: $input.item.json.current_week || null}}) }}"
      },
      "id": "eeba3f30-d87c-426e-b1c3-67261241b396",
      "name": "API: RAG (TitiNauta)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        16,
        880
      ],
      "notes": "Perguntas gerais via RAG com contexto do bebÃª"
    },
    {
      "parameters": {
        "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/appointments/create",
        "options": {
          "splitIntoItems": false
        },
        "requestMethod": "POST",
        "sendBody": true,
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "child_id",
              "value": "={{ $input.item.json.child_id }}"
            },
            {
              "name": "raw_text",
              "value": "={{ $input.item.json.message }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "x-api-key",
              "value": "={{ $vars.EDUCARE_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "contentType": "json"
      },
      "id": "1c6dfe97-455e-4075-9bc4-64379ddeca04",
      "name": "API: Appointments",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        0,
        1136
      ],
      "notes": "Agenda consultas com NLP parsing"
    },
    {
      "parameters": {
        "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/content/child",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "x-api-key",
              "value": "={{ $vars.EDUCARE_API_KEY }}"
            }
          ]
        },
        "queryParametersUi": {
          "parameter": [
            {
              "name": "weeks",
              "value": "={{ $input.item.json.current_week }}"
            }
          ]
        }
      },
      "id": "d9190aae-4619-4de6-946e-c64a781c71d5",
      "name": "API: Child Content",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        0,
        -32
      ]
    },
    {
      "parameters": {
        "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/content/mother",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "x-api-key",
              "value": "={{ $vars.EDUCARE_API_KEY }}"
            }
          ]
        },
        "queryParametersUi": {
          "parameter": [
            {
              "name": "weeks",
              "value": "={{ $input.item.json.current_week }}"
            }
          ]
        }
      },
      "id": "fcdb2bd2-6c01-446d-b770-f95f8c377da2",
      "name": "API: Mother Content",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        0,
        128
      ]
    },
    {
      "parameters": {
        "jsCode": "// Prepara resposta unificada para roteamento de saÃ­da\n// v2.0 â€” Phase 2 fix: removed Merge: Unified Data references\nconst item = $input.item;\n\n// Recuperar dados do extractor ativo nesta execuÃ§Ã£o\nlet extractorData = {};\ntry { extractorData = $('Chatwoot Extractor').item.json; } catch(e) {\n  try { extractorData = $('Evolution Extractor').item.json; } catch(e2) {\n    extractorData = {};\n  }\n}\n\nconst source = item.json.source || extractorData.source || 'evolution';\nconst responseText = item.json.response_text || item.json.answer || item.json.message || 'Mensagem recebida!';\nconst mediaType = item.json.media_type || 'text';\n\nreturn [{\n  json: {\n    ...item.json,\n    source,\n    response_text: responseText,\n    media_type: mediaType,\n    phone: item.json.phone || extractorData.phone,\n    conversation_id: item.json.conversation_id || extractorData.conversation_id || null,\n    inbox_id: item.json.inbox_id || extractorData.inbox_id || null,\n    account_id: item.json.account_id || extractorData.account_id || null\n  }\n}];"
      },
      "id": "d52f2243-68b7-4dca-affa-b8a393686db3",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        304,
        272
      ],
      "notes": "Prepara dados unificados para resposta"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.source }}",
        "rules": {
          "rules": [
            {
              "value2": "chatwoot"
            },
            {
              "value2": "evolution",
              "output": 1
            }
          ]
        },
        "fallbackOutput": 1
      },
      "id": "90a64423-8f62-4de5-9897-22edc5fc39c4",
      "name": "Router: Response Source",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        432,
        448
      ],
      "notes": "Roteia resposta para Chatwoot ou Evolution API"
    },
    {
      "parameters": {
        "url": "={{ $vars.CHATWOOT_API_URL }}/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
        "options": {},
        "requestMethod": "POST",
        "sendBody": true,
        "contentType": "json",
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "content",
              "value": "={{ $json.response_text }}"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "content_type",
              "value": "text"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "api_access_token",
              "value": "={{ $vars.CHATWOOT_API_TOKEN || '' }}"
            }
          ]
        }
      },
      "id": "d88f2d2a-1a71-4139-ada0-a8d02e597a02",
      "name": "Chatwoot: Send Text",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        560,
        288
      ],
      "notes": "Envia resposta de texto via Chatwoot API"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.media_type || 'text' }}",
        "rules": {
          "rules": [
            {
              "value2": "text"
            },
            {
              "value2": "image",
              "output": 1
            },
            {
              "value2": "audio",
              "output": 2
            },
            {
              "value2": "document",
              "output": 3
            }
          ]
        },
        "fallbackOutput": 0
      },
      "id": "26db85f2-f552-499e-a009-b70c1b7ea1c2",
      "name": "Router: Evo Output Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        656,
        432
      ],
      "notes": "Roteia resposta Evolution baseado no tipo de mÃ­dia"
    },
    {
      "parameters": {
        "url": "={{ $vars.EVOLUTION_API_URL }}/message/sendText/{{ $vars.EVOLUTION_INSTANCE }}",
        "options": {},
        "requestMethod": "POST",
        "sendBody": true,
        "contentType": "json",
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "number",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "text",
              "value": "={{ $json.response_text }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "apikey",
              "value": "={{ $vars.EVOLUTION_API_KEY || '' }}"
            }
          ]
        }
      },
      "id": "a6fb2c65-4170-4c1a-8cf9-e799af45a472",
      "name": "Evo: Send Text",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        960,
        144
      ]
    },
    {
      "parameters": {
        "url": "={{ $vars.EVOLUTION_API_URL }}/message/sendMedia/{{ $vars.EVOLUTION_INSTANCE }}",
        "options": {},
        "requestMethod": "POST",
        "sendBody": true,
        "contentType": "json",
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "number",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "mediatype",
              "value": "image"
            },
            {
              "name": "media",
              "value": "={{ $json.media_url }}"
            },
            {
              "name": "caption",
              "value": "={{ $json.response_text }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "apikey",
              "value": "={{ $vars.EVOLUTION_API_KEY || '' }}"
            }
          ]
        }
      },
      "id": "79a7281c-9d55-41ca-8b1a-530f3c4793a8",
      "name": "Evo: Send Image",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        960,
        336
      ]
    },
    {
      "parameters": {
        "url": "={{ $vars.EVOLUTION_API_URL }}/message/sendWhatsAppAudio/{{ $vars.EVOLUTION_INSTANCE }}",
        "options": {},
        "requestMethod": "POST",
        "sendBody": true,
        "contentType": "json",
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "number",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "audio",
              "value": "={{ $json.media_url }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "apikey",
              "value": "={{ $vars.EVOLUTION_API_KEY || '' }}"
            }
          ]
        }
      },
      "id": "07d71687-6614-4859-a05f-63135dc2828f",
      "name": "Evo: Send Audio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        976,
        544
      ]
    },
    {
      "parameters": {
        "url": "={{ $vars.EVOLUTION_API_URL }}/message/sendMedia/{{ $vars.EVOLUTION_INSTANCE }}",
        "options": {},
        "requestMethod": "POST",
        "sendBody": true,
        "contentType": "json",
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "number",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "mediatype",
              "value": "document"
            },
            {
              "name": "media",
              "value": "={{ $json.media_url }}"
            },
            {
              "name": "caption",
              "value": "={{ $json.response_text }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "apikey",
              "value": "={{ $vars.EVOLUTION_API_KEY || '' }}"
            }
          ]
        }
      },
      "id": "4e10b0e0-a80f-402a-a2e8-dcc4ebb3e80a",
      "name": "Evo: Send Document",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        976,
        768
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item;\nconst ref = $('Chatwoot Extractor').item.json;\n\nconst escapeMarkdown = (text = '') => text.replace(/([_*~])/g, '\\\\$1');\n\nconst phone = String(ref.phone || '');\nconst message = ref.message || '';\nconst media_type = ref.media_type || 'text';\nconst media_url = ref.media_url || null;\nconst is_audio = String(ref.is_audio || false);\nconst source_id = ref.source_id || null;\nconst timestamp = ref.timestamp || Date.now();\n\nconst conversation_id = String(ref.conversation_id || '');\nconst inbox_id = String(ref.inbox_id || '');\nconst account_id = String(ref.account_id || '');\nconst contact_id = String(ref.contact_id || '');\nconst sender_name_raw = ref.sender_name || '';\nconst sender_name = sender_name_raw.trim() || 'mamÃ£e/papai';\nconst safe_sender_name = escapeMarkdown(sender_name);\n\nconst thumbnail = ref.raw?.sender?.thumbnail ?? null;\nconst account_name = ref.raw?.account?.name ?? 'Educare+';\nconst inbox_name = ref.raw?.inbox?.name ?? 'WhatsApp';\n\nconst response_text = `Oi, ${safe_sender_name}! ðŸ‘‹\n\nNotei que vocÃª ainda nÃ£o tem uma conta ativa no app *${account_name}*. Com ele, vocÃª acompanha vacinas, consultas, fases do bebÃª, tudo com muito carinho e praticidade. ðŸ‘¶âœ¨\n\nðŸ’™ Que tal experimentar o app gratuitamente?\n\nðŸ“² Baixe agora: https://educareapp.com.br/app\n\nSe preferir, posso te ajudar por aqui no WhatsApp (${inbox_name}) tambÃ©m!`;\n\nreturn [{\n  json: {\n    phone,\n    message,\n    media_type,\n    media_url,\n    is_audio,\n    source_id,\n    timestamp,\n    conversation_id,\n    inbox_id,\n    account_id,\n    contact_id,\n    sender_name,\n    thumbnail,\n    source: 'chatwoot',\n    response_text,\n    user_found: false,\n    lead_status: 'novo'\n  }\n}];"
      },
      "id": "873f7608-c956-4d1f-9140-151357602a33",
      "name": "Prepare: No User Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -1184,
        784
      ]
    },
    {
      "parameters": {
        "jsCode": "// Prepara mensagem para usuÃ¡rios com assinatura inativa\n// v2.0 â€” Phase 2 fix: removed Merge: Unified Data references\nconst base = $input.item.json;\n\n// Recuperar dados do extractor ativo nesta execuÃ§Ã£o\nlet extractorData = {};\ntry { extractorData = $('Chatwoot Extractor').item.json; } catch(e) {\n  try { extractorData = $('Evolution Extractor').item.json; } catch(e2) {\n    extractorData = {};\n  }\n}\n\nconst phone = base.phone || extractorData.phone || '';\n\nreturn [{\n  json: {\n    channel: base.source || extractorData.source || 'evolution',\n    source: base.source || extractorData.source || 'evolution',\n    message_id: base.message_id || base.id || String(base.timestamp || $execution.id),\n    phone,\n    text: base.text || base.message || base.body || '',\n    user: {\n      user_id: base.user_id || (base.user ? (base.user.id || base.user.user_id) : undefined),\n      name: base.user_name || (base.user ? base.user.name : '') || '',\n      subscription_status: base.subscription_status || (base.user ? base.user.subscription_status : '') || 'inactive',\n      stripe_customer_id: base.stripe_customer_id || (base.user ? base.user.stripe_customer_id : '') || '',\n      stripe_checkout_url: base.stripe_checkout_url || ''\n    },\n    ctx: {\n      locale: base.locale || 'pt-BR',\n      campaign_id: base.campaign_id || 'inactive_reactivation_v1',\n      conversation_id: extractorData.conversation_id || null,\n      inbox_id: extractorData.inbox_id || null,\n      account_id: extractorData.account_id || null\n    }\n  }\n}];"
      },
      "id": "f594a78d-d93c-494f-88d5-73c49cefd846",
      "name": "Prepare: Inactive Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -960,
        768
      ]
    },
    {
      "parameters": {
        "content": "ValidaÃ§Ã£o de usuÃ¡rio, classificaÃ§Ã£o, e  descarte de mensagem geradas por agentes. Ou atualizaÃ§Ãµes do chatwoot ou evolution.",
        "height": 480,
        "width": 1104
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3728,
        496
      ],
      "id": "54cbb66f-6337-49bf-93b2-d952dae3b6d5",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "Detecta o tipo de mensagem (texto, audio, etc.)",
        "height": 800,
        "width": 1040,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2528,
        304
      ],
      "id": "bd7fd420-7656-4601-9703-a57a116e5c82",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        -2208,
        384
      ],
      "id": "a15cb076-9a83-4d14-8662-7e047eb06203",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "gddH24JwjrAV57aC",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8d59441a-8a58-4dae-8bad-8477b148786b",
              "name": "phone",
              "value": "={{$json.phone}}",
              "type": "string"
            },
            {
              "id": "30ddb993-997d-4fa8-8418-c07c48f96624",
              "name": "name",
              "value": "={{$json.sender_name}}\n",
              "type": "string"
            },
            {
              "id": "a5077ce4-5e0c-4f3c-9785-de5c9d5b6b55",
              "name": "lastmessage",
              "value": "={{$json.message}}",
              "type": "string"
            },
            {
              "id": "168d7eff-bfd3-46fd-8112-10b795103105",
              "name": "media_type",
              "value": "={{$json.media_type}}",
              "type": "string"
            },
            {
              "id": "d1c66522-0cfa-48cb-9918-f7f20c97a8ed",
              "name": "media_url",
              "value": "={{$json.media_url}}",
              "type": "string"
            },
            {
              "id": "32f49946-61b4-4c0b-8ecb-dfa927849f6c",
              "name": "is_audio",
              "value": "={{$json.is_audio}}",
              "type": "boolean"
            },
            {
              "id": "b4e529ad-2ec8-419d-bc4c-6fd3d2f0072d",
              "name": "source",
              "value": "={{$json.source}}",
              "type": "string"
            },
            {
              "id": "dd0c314f-ae01-4c71-a102-ce9a5c3d0708",
              "name": "source_id",
              "value": "={{$json.source_id}}",
              "type": "string"
            },
            {
              "id": "5e264e66-8654-4623-97b8-feba01a06db5",
              "name": "timestamp",
              "value": "={{$json.timestamp}}",
              "type": "number"
            },
            {
              "id": "864ea5bf-be3e-4764-a38d-4447b29cb624",
              "name": "conversation_id",
              "value": "={{$json.conversation_id}}",
              "type": "string"
            },
            {
              "id": "937ef3c0-a6de-4b81-ab7c-3db3e0772eaa",
              "name": "inbox_id",
              "value": "={{ $json.inbox_id }}",
              "type": "string"
            },
            {
              "id": "ec2a4fb8-d54c-4b1c-8439-9543164520ce",
              "name": "account_id",
              "value": "={{ $json.account_id }}",
              "type": "string"
            },
            {
              "id": "6408684e-59ac-43f7-a2e9-5aea4a5030e4",
              "name": "contact_id",
              "value": "={{ $json.contact_id }}",
              "type": "string"
            },
            {
              "id": "ccefef9e-50db-4a5e-941f-afb9fed2643e",
              "name": "sender_name",
              "value": "={{ $json.sender_name }}",
              "type": "string"
            },
            {
              "id": "ea85d2fc-e888-4418-88c1-a90de65c08c9",
              "name": "thumbnail",
              "value": "={{ $json.thumbnail }}",
              "type": "string"
            },
            {
              "id": "c4083e63-e4fe-4313-aaa5-7909edb7c7db",
              "name": "lead_status",
              "value": "={{ $json.lead_status }}",
              "type": "string"
            },
            {
              "id": "6df6bcdd-63fc-4b16-99fb-a8b596a5b535",
              "name": "user_found",
              "value": "={{ $json.user_found }}",
              "type": "boolean"
            },
            {
              "id": "bbb87b09-5467-40d7-9fdf-8c2a84f67f50",
              "name": "response_text",
              "value": "={{ $json.response_text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1184,
        960
      ],
      "id": "b3c3bba5-51be-4b40-af77-96aa016f47b9",
      "name": "Edit Fields",
      "notes": "Dados para tratar leads"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "45663cbc-a1b9-46d2-9fa5-0d6b32039e88",
              "leftValue": "={{$json.is_human}}",
              "rightValue": "incoming",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -3696,
        672
      ],
      "id": "66fee6be-f9d6-442a-977b-d56a5ef973c7",
      "name": "Ã‰ humano?"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -960,
        976
      ],
      "id": "00fa1dae-5a2c-47f7-b5d9-65d75077617c",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "jGZCuPWlkZa8v9OB",
          "mode": "list",
          "cachedResultUrl": "/workflow/jGZCuPWlkZa8v9OB",
          "cachedResultName": "SUB | Inactive User Reactivation (WhatsApp + Stripe + PG Memory)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "thisFieldAcceptsAnyType": "={{$json}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "aField",
              "displayName": "aField",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "aNumber",
              "displayName": "aNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": true
            },
            {
              "id": "thisFieldAcceptsAnyType",
              "displayName": "thisFieldAcceptsAnyType",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "anArray",
              "displayName": "anArray",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "array",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -736,
        976
      ],
      "id": "12f082d0-0412-4824-b7c6-4767c3e1b1d4",
      "name": "Call 'Agente Lead - long memory'1"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "n6ZpQvp96iPCaIvG",
          "mode": "list",
          "cachedResultUrl": "/workflow/n6ZpQvp96iPCaIvG",
          "cachedResultName": "Lead CRM"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "thisFieldAcceptsAnyType": "={{$json}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "aField",
              "displayName": "aField",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "aNumber",
              "displayName": "aNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": true
            },
            {
              "id": "thisFieldAcceptsAnyType",
              "displayName": "thisFieldAcceptsAnyType",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "anArray",
              "displayName": "anArray",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "array",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -1168,
        1168
      ],
      "id": "14fd7168-4324-463f-8d7a-19f617a6b4b3",
      "name": "Call 'Agente Lead'"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-globals.globalConstants",
      "typeVersion": 1,
      "position": [
        -1856,
        624
      ],
      "id": "8cdeb497-286a-4d70-bae7-756e8c68eb99",
      "name": "Global Constants",
      "alwaysOutputData": true,
      "credentials": {
        "globalConstantsApi": {
          "id": "I0U483eFAXTruzVB",
          "name": "Global Constants account"
        }
      }
    }
  ],
  "connections": {
    "Webhook (Unified Entry)": {
      "main": [
        [
          {
            "node": "Source Detector",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Source Detector": {
      "main": [
        [
          {
            "node": "Ã‰ humano?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router: Source Type": {
      "main": [
        [
          {
            "node": "Chatwoot Extractor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Evolution Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chatwoot Extractor": {
      "main": [
        [
          {
            "node": "Gate: Not Skipped?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evolution Extractor": {
      "main": [
        [
          {
            "node": "Gate: Not Skipped?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gate: Not Skipped?": {
      "main": [
        [
          {
            "node": "Router: Input Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router: Input Type": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Global Constants",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Normalize Audio": {
      "main": [
        [
          {
            "node": "Global Constants",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Check User": {
      "main": [
        [
          {
            "node": "Gate: User Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gate: User Exists?": {
      "main": [
        [
          {
            "node": "Gate: Active Sub?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare: No User Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gate: Active Sub?": {
      "main": [
        [
          {
            "node": "Engine: Calc Weeks",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare: Inactive Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare: No User Msg": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare: Inactive Msg": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Engine: Calc Weeks": {
      "main": [
        [
          {
            "node": "Intent Classifier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router: Intent Switch": {
      "main": [
        [
          {
            "node": "Router: Menu Options",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Biometrics",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Sleep Log",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Vaccines",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: RAG (TitiNauta)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Appointments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router: Menu Options": {
      "main": [
        [
          {
            "node": "API: Child Content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Mother Content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Vaccines",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: RAG (TitiNauta)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Biometrics": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Sleep Log": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Vaccines": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: RAG (TitiNauta)": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Appointments": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Child Content": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Mother Content": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Response": {
      "main": [
        [
          {
            "node": "Router: Response Source",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router: Response Source": {
      "main": [
        [
          {
            "node": "Chatwoot: Send Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router: Evo Output Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router: Evo Output Type": {
      "main": [
        [
          {
            "node": "Evo: Send Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Evo: Send Image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Evo: Send Audio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Evo: Send Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Normalize Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Call 'Agente Lead'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ã‰ humano?": {
      "main": [
        [
          {
            "node": "Router: Source Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Call 'Agente Lead - long memory'1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Global Constants": {
      "main": [
        [
          {
            "node": "API: Check User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intent Classifier": {
      "main": [
        [
          {
            "node": "Router: Intent Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook (Unified Entry)": [
      {
        "json": {
          "headers": {
            "host": "webhook.educareapp.com.br",
            "user-agent": "axios/1.13.2",
            "content-length": "1416",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "webhook.educareapp.com.br",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "594e0b156d57",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.upsert",
            "instance": "educare-chat",
            "data": {
              "key": {
                "remoteJid": "559891628206@s.whatsapp.net",
                "remoteJidAlt": "47450899411065@lid",
                "fromMe": false,
                "id": "3A9028539DF368FD6078",
                "participant": "",
                "addressingMode": "pn"
              },
              "pushName": "Derik Silva",
              "status": "DELIVERY_ACK",
              "message": {
                "conversation": "Boa noite",
                "messageContextInfo": {
                  "threadId": [],
                  "deviceListMetadata": {
                    "senderKeyIndexes": [],
                    "recipientKeyIndexes": [],
                    "senderKeyHash": {
                      "0": 212,
                      "1": 179,
                      "2": 129,
                      "3": 104,
                      "4": 1,
                      "5": 92,
                      "6": 37,
                      "7": 230,
                      "8": 137,
                      "9": 186
                    },
                    "senderTimestamp": {
                      "low": 1770162773,
                      "high": 0,
                      "unsigned": true
                    },
                    "recipientKeyHash": {
                      "0": 160,
                      "1": 139,
                      "2": 11,
                      "3": 251,
                      "4": 46,
                      "5": 187,
                      "6": 134,
                      "7": 223,
                      "8": 116,
                      "9": 125
                    },
                    "recipientTimestamp": {
                      "low": 1768698230,
                      "high": 0,
                      "unsigned": true
                    }
                  },
                  "deviceListMetadataVersion": 2,
                  "messageSecret": {
                    "0": 106,
                    "1": 119,
                    "2": 184,
                    "3": 36,
                    "4": 34,
                    "5": 175,
                    "6": 18,
                    "7": 246,
                    "8": 231,
                    "9": 117,
                    "10": 202,
                    "11": 88,
                    "12": 141,
                    "13": 35,
                    "14": 69,
                    "15": 167,
                    "16": 55,
                    "17": 121,
                    "18": 212,
                    "19": 124,
                    "20": 158,
                    "21": 138,
                    "22": 64,
                    "23": 12,
                    "24": 19,
                    "25": 36,
                    "26": 162,
                    "27": 111,
                    "28": 58,
                    "29": 58,
                    "30": 202,
                    "31": 27
                  }
                }
              },
              "messageType": "conversation",
              "messageTimestamp": 1770417124,
              "instanceId": "55fb93e4-9a8a-40a1-8761-6f4926a0da7f",
              "source": "ios"
            },
            "destination": "https://webhook.educareapp.com.br/webhook/chat",
            "date_time": "2026-02-06T19:32:04.366Z",
            "sender": "559192018206@s.whatsapp.net",
            "server_url": "https://api.educareapp.com.br",
            "apikey": "0C7951B425D6-458B-B662-1FF1EFDE0AFF"
          },
          "webhookUrl": "https://webhook.educareapp.com.br/webhook/webhook/chat",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "versionId": "8930c704-2207-487e-bfab-bab59e73678c",
  "activeVersionId": "8930c704-2207-487e-bfab-bab59e73678c",
  "versionCounter": 402,
  "triggerCount": 1,
  "tags": [
    {
      "updatedAt": "2025-12-21T13:03:08.318Z",
      "createdAt": "2025-12-21T13:03:08.318Z",
      "id": "FCtg3of3kkHgvSJd",
      "name": "Educare+"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-02-07T22:05:23.966Z",
    "createdAt": "2026-02-07T22:05:23.966Z",
    "versionId": "8930c704-2207-487e-bfab-bab59e73678c",
    "workflowId": "iLDio0CFRs2Qa1VM",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "chat",
          "options": {}
        },
        "id": "801324b6-72df-42cd-9ab1-91ee230dad0e",
        "name": "Webhook (Unified Entry)",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 1,
        "position": [
          -4160,
          672
        ],
        "webhookId": "f44aaa18-a489-4a77-a5af-b3f5b20953a9",
        "notes": "Ponto de entrada unificado - recebe mensagens do Evolution API OU Chatwoot"
      },
      {
        "parameters": {
          "jsCode": "// Source Detector v4.2 - Chatwoot + Evolution (normalizaÃ§Ã£o correta)\n\nconst items = $input.all();\nconst results = [];\n\nfunction pickTextFromEvolutionMessage(msg = {}) {\n  return (\n    msg.conversation ||\n    msg.extendedTextMessage?.text ||\n    msg.imageMessage?.caption ||\n    msg.videoMessage?.caption ||\n    msg.documentMessage?.caption ||\n    null\n  );\n}\n\nfunction pickMediaFromEvolutionMessage(msg = {}) {\n  // URL Ã s vezes nÃ£o vem no upsert; pode exigir etapa posterior de download\n  if (msg.imageMessage) return { type: \"image\", mime: msg.imageMessage.mimetype || null, url: null };\n  if (msg.videoMessage) return { type: \"video\", mime: msg.videoMessage.mimetype || null, url: null };\n  if (msg.audioMessage) return { type: \"audio\", mime: msg.audioMessage.mimetype || null, url: null };\n  if (msg.documentMessage) return { type: \"document\", mime: msg.documentMessage.mimetype || null, url: null };\n  return { type: null, mime: null, url: null };\n}\n\nfor (const item of items) {\n  const body = item.json.body || item.json || {};\n\n  // Detectar Chatwoot\n  const isChatwoot = !!(body.event && body.conversation);\n\n  // Detectar Evolution\n  const data = body.data || body;\n  const isEvolution = !!(data.key?.remoteJid);\n\n  let source = \"unknown\";\n  if (isChatwoot) source = \"chatwoot\";\n  else if (isEvolution) source = \"evolution\";\n\n  // Defaults (mantÃ©m compatibilidade com o resto do fluxo)\n  let nome = null;\n  let contato = null;\n  let id_mensagem = null;\n  let mensagem = null;\n  let type_message = null;\n  let url_anexo = null;\n  let mime_type = null;\n  let canal = null;\n  let instancia = body.instance || body.instancia || \"educare-chat\";\n  let origem = null;\n  let timestamp = body.timestamp || body.created_at || new Date().toISOString();\n\n  // Flag humano (default)\n  let is_human = null;\n\n  // ---- NormalizaÃ§Ã£o por fonte ----\n  if (isChatwoot) {\n    nome = body.sender?.name || body.sender_name || null;\n    contato = body.sender?.phone_number?.replace(\"+\", \"\") || body.phone || null;\n    id_mensagem = body.id || body.message_id || null;\n    mensagem = body.message || body.content || null;\n    type_message = body.content_type || body.type_message || null;\n    url_anexo = body.url_anexo || null;\n    mime_type = body.mime_type || null;\n    canal = body.conversation?.channel || body.canal || null;\n    origem = body.inbox?.name || body.origem || null;\n\n    // Chatwoot: humano geralmente Ã© quem NÃƒO Ã© \"private note\"/bot/etc (depende da sua regra)\n    // Mantendo neutro:\n    is_human = true;\n  }\n\n  if (isEvolution) {\n    const key = data.key || {};\n    const msg = data.message || {};\n\n    nome = data.pushName || null;\n    contato = key.remoteJid ? key.remoteJid.split(\"@\")[0] : null;\n    id_mensagem = key.id || null;\n\n    const text = pickTextFromEvolutionMessage(msg);\n    const media = pickMediaFromEvolutionMessage(msg);\n\n    mensagem = text;\n    type_message = data.messageType || media.type || null;\n    url_anexo = media.url;\n    mime_type = media.mime;\n\n    canal = \"evolution\";\n    origem = \"whatsapp\";\n\n    // Use o timestamp da prÃ³pria mensagem se existir\n    timestamp = data.messageTimestamp\n      ? new Date(Number(data.messageTimestamp) * 1000).toISOString()\n      : timestamp;\n\n    // HUMANO = inbound (fromMe === false) + tem conteÃºdo (texto ou mÃ­dia)\n    const hasContent = !!text || !!media.type;\n    is_human = (key.fromMe === false) && hasContent;\n  }\n\n  const enrichedData = {\n    source,\n    raw_body: body,\n    is_chatwoot: isChatwoot,\n    is_evolution: isEvolution,\n\n    nome,\n    contato,\n    id_mensagem,\n    mensagem,\n    type_message,\n    url_anexo,\n    mime_type,\n    canal,\n    instancia,\n    origem,\n    timestamp,\n\n    // Campos auxiliares Ãºteis pro fluxo:\n    is_human,\n    from_me: isEvolution ? (data.key?.fromMe ?? null) : null,\n    remote_jid: isEvolution ? (data.key?.remoteJid ?? null) : null\n  };\n\n  results.push({ json: enrichedData });\n}\n\nreturn results;"
        },
        "id": "300684ba-6022-423b-afa9-c4625b081598",
        "name": "Source Detector",
        "type": "n8n-nodes-base.code",
        "typeVersion": 1,
        "position": [
          -3904,
          672
        ],
        "notes": "Identifica se a mensagem vem do Chatwoot ou Evolution API"
      },
      {
        "parameters": {
          "dataType": "string",
          "value1": "={{ $json.source }}",
          "rules": {
            "rules": [
              {
                "value2": "chatwoot"
              },
              {
                "value2": "evolution",
                "output": 1
              }
            ]
          }
        },
        "id": "8373b41d-efc1-4e0c-b4da-70afb219d615",
        "name": "Router: Source Type",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 1,
        "position": [
          -3392,
          624
        ],
        "notes": "Roteia para extrator especÃ­fico baseado na fonte"
      },
      {
        "parameters": {
          "jsCode": "// Chatwoot Extractor v4.2\n// ExtraÃ§Ã£o robusta de mensagens e anexos do Chatwoot\n\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const body = item.json.raw || item.json.raw_body || {};\n  const event = body.event || '';\n  const conversation = body.conversation || {};\n  const meta = conversation.meta || {};\n  const sender = meta.sender || {};\n  const messages = conversation.messages || [];\n  const latestMessage = messages[messages.length - 1] || {};\n\n  const messageType = latestMessage.message_type || '';\n\n  // Filtrar apenas mensagens do usuÃ¡rio\n  if (event !== 'message_created' || messageType === 'outgoing') {\n    results.push({ json: { skip: true, reason: 'not_incoming_message' } });\n    continue;\n  }\n\n  // Anexos\n  let attachments = body.attachments || [];\n  if (attachments.length === 0 && latestMessage.attachments) {\n    attachments = latestMessage.attachments;\n  }\n\n  // Telefone\n  let phone = sender.phone_number || sender.identifier || '';\n  phone = phone.replace(/\\D/g, '').replace('@s.whatsapp.net', '');\n  if (phone.startsWith('+')) phone = phone.substring(1);\n\n  // ConteÃºdo da mensagem\n  const message = latestMessage.content || body.content || '';\n\n  // Detectar mÃ­dia\n  let is_audio = false;\n  let media_url = null;\n  let media_type = 'text';\n\n  const audio = attachments.find(a => a.file_type === 'audio');\n  const image = attachments.find(a => a.file_type === 'image');\n  const doc = attachments.find(a => ['file', 'document'].includes(a.file_type));\n\n  if (audio) {\n    is_audio = true;\n    media_type = 'audio';\n    media_url = audio.data_url;\n  } else if (image) {\n    media_type = 'image';\n    media_url = image.data_url;\n  } else if (doc) {\n    media_type = 'document';\n    media_url = doc.data_url;\n  }\n\n  results.push({\n    json: {\n      source: 'chatwoot',\n      phone,\n      message,\n      is_audio,\n      media_url,\n      media_type,\n      source_id: latestMessage.source_id || '',\n      conversation_id: conversation.id,\n      inbox_id: body.inbox?.id || conversation.inbox_id,\n      account_id: body.account?.id,\n      contact_id: sender.id,\n      sender_name: sender.name || '',\n      timestamp: latestMessage.created_at || body.created_at || new Date().toISOString(),\n      raw: body\n    }\n  });\n}\n\nreturn results.length ? results : [{ json: { skip: true } }];"
        },
        "id": "cd241153-9467-4752-b166-ff0d28b4b801",
        "name": "Chatwoot Extractor",
        "type": "n8n-nodes-base.code",
        "typeVersion": 1,
        "position": [
          -3072,
          528
        ],
        "notes": "Extrai phone, message, audio de webhooks Chatwoot"
      },
      {
        "parameters": {
          "jsCode": "// Evolution API Extractor v4.1\n// ExtraÃ§Ã£o de mensagens com mÃ­dia, texto e botÃµes - padronizado\n\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const body = item.json.raw_body || {};\n  const data = body.data || body;\n  const key = data.key || {};\n  const msg = data.message || {};\n\n  // 1. Filtro: ignora mensagens enviadas por si ou de status\n  if (key.fromMe || key.remoteJid?.includes('status')) {\n    results.push({ json: { skip: true, reason: 'from_me_or_status' } });\n    continue;\n  }\n\n  // 2. Extrair telefone\n  const phone = key.remoteJid?.replace(/\\D/g, '').replace('@s.whatsapp.net', '') || '';\n\n  // 3. Detectar tipo de mensagem/mÃ­dia\n  let is_audio = false;\n  let media_url = null;\n  let message = '';\n  let media_type = 'text';\n  const type_message = Object.keys(msg)[0] || 'unknown';\n\n  if (msg.audioMessage) {\n    is_audio = true;\n    media_url = msg.audioMessage.url || data.mediaUrl;\n    media_type = 'audio';\n  } else if (msg.imageMessage) {\n    media_url = msg.imageMessage.url || data.mediaUrl;\n    message = msg.imageMessage.caption || '';\n    media_type = 'image';\n  } else if (msg.documentMessage) {\n    media_url = msg.documentMessage.url || data.mediaUrl;\n    message = msg.documentMessage.caption || '';\n    media_type = 'document';\n  } else if (msg.conversation) {\n    message = msg.conversation;\n  } else if (msg.extendedTextMessage) {\n    message = msg.extendedTextMessage.text;\n  } else if (msg.buttonsResponseMessage) {\n    message = msg.buttonsResponseMessage.selectedButtonId;\n  } else if (msg.listResponseMessage) {\n    message = msg.listResponseMessage.singleSelectReply?.selectedRowId || '';\n  }\n\n  results.push({\n    json: {\n      source: 'evolution',\n      phone,\n      message,\n      is_audio,\n      media_url,\n      media_type,\n      type_message,\n      conversation_id: null,\n      inbox_id: null,\n      account_id: null,\n      contact_id: null,\n      sender_name: data.pushName || '',\n      timestamp: data.messageTimestamp || data.messageTimestampMs || new Date().toISOString(),\n      raw: data\n    }\n  });\n}\n\nreturn results.length ? results : [{ json: { skip: true } }];"
        },
        "id": "6c0617aa-8bcf-4266-be9e-dbee037442b8",
        "name": "Evolution Extractor",
        "type": "n8n-nodes-base.code",
        "typeVersion": 1,
        "position": [
          -3072,
          736
        ],
        "notes": "Extrai phone, message, audio de webhooks Evolution API"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 1
            },
            "conditions": [
              {
                "id": "skip",
                "leftValue": "={{ $json.skip }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "notEquals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "b5e1eb68-9b03-47f5-888e-29f691aa7c16",
        "name": "Gate: Not Skipped?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -2752,
          640
        ],
        "notes": "Filtra mensagens que devem ser ignoradas (skip=true)"
      },
      {
        "parameters": {
          "dataType": "boolean",
          "value1": "={{ $json.is_audio }}",
          "rules": {
            "rules": [
              {
                "operation": "notEqual"
              },
              {
                "output": 1
              }
            ]
          }
        },
        "id": "c47042b2-2f79-4d59-b0cf-b452703d4a06",
        "name": "Router: Input Type",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 1,
        "position": [
          -2400,
          592
        ]
      },
      {
        "parameters": {
          "jsCode": "// Normaliza o Ã¡udio transcrito para texto\nconst item = $input.item;\nreturn [{\n  json: {\n    ...item.json,\n    message: item.json.text || item.json.message, \n    is_audio_transcribed: true\n  }\n}];"
        },
        "id": "13785ce9-b68c-4614-b07e-caee1e59f9f5",
        "name": "Normalize Audio",
        "type": "n8n-nodes-base.code",
        "typeVersion": 1,
        "position": [
          -2032,
          384
        ]
      },
      {
        "parameters": {
          "requestMethod": "GET",
          "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/users/check",
          "options": {
            "splitIntoItems": false
          },
          "headerParametersUi": {
            "parameter": [
              {
                "name": "x-api-key",
                "value": "={{ $vars.EDUCARE_API_KEY }}"
              }
            ]
          },
          "queryParametersUi": {
            "parameter": [
              {
                "name": "phone",
                "value": "={{ $input.item.json.phone }}"
              }
            ]
          }
        },
        "id": "e9882692-7e4f-4370-81a4-87b4683aad19",
        "name": "API: Check User",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          -1648,
          624
        ],
        "notes": "Verifica se usuÃ¡rio existe e status da assinatura"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 1
            },
            "conditions": [
              {
                "id": "exists",
                "leftValue": "={{ $json.exists }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "9318ec1d-6d10-4440-bd08-c850d335dfc3",
        "name": "Gate: User Exists?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -1200,
          576
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 1
            },
            "conditions": [
              {
                "id": "active",
                "leftValue": "={{ $json.subscription_status }}",
                "rightValue": "active",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              },
              {
                "id": "trialing",
                "leftValue": "={{ $json.subscription_status }}",
                "rightValue": "trialing",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "id": "8fa51ab3-a33a-44ad-8af3-658bdd05162b",
        "name": "Gate: Active Sub?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -960,
          512
        ]
      },
      {
        "parameters": {
          "jsCode": "// Motor Temporal: Define a semana da crianÃ§a\nconst item = $input.item;\nconst child = item.json.child || {};\n\nif (!child.dob) {\n  return [{ json: { \n    ...item.json,\n    error: 'no_dob',\n    target_flow: 'onboarding', \n    response_text: 'Por favor, cadastre seu bebÃª no app Educare+ primeiro.' \n  } }];\n}\n\nconst dob = new Date(child.dob);\nconst diff = Math.abs(new Date() - dob);\nconst currentWeek = Math.floor(Math.ceil(diff / (1000 * 60 * 60 * 24)) / 7);\n\nreturn [{ \n  json: { \n    ...item.json, \n    current_week: currentWeek, \n    child_id: child.id, \n    child_name: child.name \n  } \n}];"
        },
        "id": "16ff861a-9f3e-467d-bd41-0faae8a64562",
        "name": "Engine: Calc Weeks",
        "type": "n8n-nodes-base.code",
        "typeVersion": 1,
        "position": [
          -768,
          496
        ],
        "notes": "Calcula a semana de vida do bebÃª baseado na data de nascimento"
      },
      {
        "parameters": {
          "jsCode": "// Deterministic Intent Classifier v1.0\n// Classifica a intenÃ§Ã£o do usuÃ¡rio por palavras-chave\nconst item = $input.item;\nconst msg = (item.json.message || '').toString().trim().toLowerCase();\n\nlet intent = 'question'; // fallback = RAG\n\n// Menu navigation\nif (/^(menu|opÃ§Ãµes|opcoes|ajuda|help|inÃ­cio|inicio|voltar)$/i.test(msg) || /^\\d$/.test(msg)) {\n  intent = 'menu_nav';\n}\n// Biometrics (weight, height, head)\nelse if (/peso|quilos?|kg|gramas?|altura|mede|centÃ­metros?|cm|perÃ­metro|cefÃ¡lico|cabeÃ§a/i.test(msg)) {\n  intent = 'biometrics';\n}\n// Sleep\nelse if (/sono|dormi[rua]?|acordou|cochilo|soneca|noite|madrugada|nap/i.test(msg)) {\n  intent = 'sleep';\n}\n// Vaccines\nelse if (/vacina|imuniza|bcg|hepatite|pentavalente|polio|trÃ­plice|rotavÃ­rus|pneumo|meningo|febre amarela|varicela|dose/i.test(msg)) {\n  intent = 'vaccine';\n}\n// Appointments\nelse if (/consulta|mÃ©dico|doutor|dra?\\.|pediatra|especialista|exame|agend|marcar|clÃ­nica|ubs|hospital/i.test(msg)) {\n  intent = 'appointment';\n}\n\nreturn [{\n  json: {\n    ...item.json,\n    intent,\n    classifier_version: 'deterministic_v1'\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 1,
        "position": [
          -608,
          496
        ],
        "id": "4b27a7f6-d9d0-4831-828b-cfda3da83e43",
        "name": "Intent Classifier",
        "disabled": false,
        "alwaysOutputData": true,
        "notes": "Classificador determinÃ­stico por palavras-chave â€” substitui AI Classifier desabilitado"
      },
      {
        "parameters": {
          "dataType": "string",
          "value1": "={{ ($json.intent || $json.message || '').toString().trim().toLowerCase() }}",
          "rules": {
            "rules": [
              {
                "value2": "menu_nav"
              },
              {
                "value2": "biometrics",
                "output": 1
              },
              {
                "value2": "sleep",
                "output": 2
              },
              {
                "value2": "vaccine",
                "output": 3
              },
              {
                "value2": "question",
                "output": 4
              },
              {
                "value2": "appointment",
                "output": 5
              }
            ]
          },
          "fallbackOutput": 4
        },
        "id": "ae984e0c-eae3-43fd-ab6f-ec55a0f1ac25",
        "name": "Router: Intent Switch",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 1,
        "position": [
          -432,
          464
        ]
      },
      {
        "parameters": {
          "dataType": "string",
          "value1": "={{ $input.item.json.message }}",
          "rules": {
            "rules": [
              {
                "value2": "1"
              },
              {
                "value2": "2",
                "output": 1
              },
              {
                "value2": "3",
                "output": 2
              },
              {
                "value2": "4",
                "output": 3
              },
              {
                "value2": "5",
                "output": 3
              }
            ]
          },
          "fallbackOutput": 0
        },
        "id": "fe8880af-20a8-478a-a932-3085497ace29",
        "name": "Router: Menu Options",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 1,
        "position": [
          -272,
          240
        ]
      },
      {
        "parameters": {
          "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/biometrics/update",
          "options": {
            "splitIntoItems": false
          },
          "requestMethod": "POST",
          "sendBody": true,
          "bodyParametersUi": {
            "parameter": [
              {
                "name": "child_id",
                "value": "={{ $input.item.json.child_id }}"
              },
              {
                "name": "raw_text",
                "value": "={{ $input.item.json.message }}"
              }
            ]
          },
          "headerParametersUi": {
            "parameter": [
              {
                "name": "x-api-key",
                "value": "={{ $vars.EDUCARE_API_KEY }}"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "contentType": "json"
        },
        "id": "cbcbb161-43c4-41bc-9a8a-2332a94096cd",
        "name": "API: Biometrics",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          0,
          304
        ],
        "notes": "Registra peso/altura com NLP parsing"
      },
      {
        "parameters": {
          "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/sleep/log",
          "options": {
            "splitIntoItems": false
          },
          "requestMethod": "POST",
          "sendBody": true,
          "bodyParametersUi": {
            "parameter": [
              {
                "name": "child_id",
                "value": "={{ $input.item.json.child_id }}"
              },
              {
                "name": "raw_text",
                "value": "={{ $input.item.json.message }}"
              }
            ]
          },
          "headerParametersUi": {
            "parameter": [
              {
                "name": "x-api-key",
                "value": "={{ $vars.EDUCARE_API_KEY }}"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "contentType": "json"
        },
        "id": "072a06aa-c76e-4077-8bc8-f9a247e70aff",
        "name": "API: Sleep Log",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          16,
          480
        ],
        "notes": "Registra sono com NLP parsing"
      },
      {
        "parameters": {
          "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/vaccines/check",
          "options": {},
          "headerParametersUi": {
            "parameter": [
              {
                "name": "x-api-key",
                "value": "={{ $vars.EDUCARE_API_KEY }}"
              }
            ]
          },
          "queryParametersUi": {
            "parameter": [
              {
                "name": "childId",
                "value": "={{ $input.item.json.child_id }}"
              },
              {
                "name": "age_weeks",
                "value": "={{ $input.item.json.current_week }}"
              }
            ]
          }
        },
        "id": "d76b5f9e-9621-471e-82c0-dd5960ed373d",
        "name": "API: Vaccines",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          16,
          672
        ],
        "notes": "Verifica calendÃ¡rio vacinal SBP"
      },
      {
        "parameters": {
          "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/rag/ask",
          "options": {
            "splitIntoItems": false
          },
          "requestMethod": "POST",
          "headerParametersUi": {
            "parameter": [
              {
                "name": "x-api-key",
                "value": "={{ $vars.EDUCARE_API_KEY }}"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "contentType": "json",
          "sendBody": true,
          "jsonParameters": true,
          "body": "={{ JSON.stringify({question: $input.item.json.message, context: {child_id: $input.item.json.child_id || null, week: $input.item.json.current_week || null}}) }}"
        },
        "id": "eeba3f30-d87c-426e-b1c3-67261241b396",
        "name": "API: RAG (TitiNauta)",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          16,
          880
        ],
        "notes": "Perguntas gerais via RAG com contexto do bebÃª"
      },
      {
        "parameters": {
          "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/appointments/create",
          "options": {
            "splitIntoItems": false
          },
          "requestMethod": "POST",
          "sendBody": true,
          "bodyParametersUi": {
            "parameter": [
              {
                "name": "child_id",
                "value": "={{ $input.item.json.child_id }}"
              },
              {
                "name": "raw_text",
                "value": "={{ $input.item.json.message }}"
              }
            ]
          },
          "headerParametersUi": {
            "parameter": [
              {
                "name": "x-api-key",
                "value": "={{ $vars.EDUCARE_API_KEY }}"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "contentType": "json"
        },
        "id": "1c6dfe97-455e-4075-9bc4-64379ddeca04",
        "name": "API: Appointments",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          0,
          1136
        ],
        "notes": "Agenda consultas com NLP parsing"
      },
      {
        "parameters": {
          "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/content/child",
          "options": {},
          "headerParametersUi": {
            "parameter": [
              {
                "name": "x-api-key",
                "value": "={{ $vars.EDUCARE_API_KEY }}"
              }
            ]
          },
          "queryParametersUi": {
            "parameter": [
              {
                "name": "weeks",
                "value": "={{ $input.item.json.current_week }}"
              }
            ]
          }
        },
        "id": "d9190aae-4619-4de6-946e-c64a781c71d5",
        "name": "API: Child Content",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          0,
          -32
        ]
      },
      {
        "parameters": {
          "url": "={{ $vars.EDUCARE_API_URL }}/api/n8n/content/mother",
          "options": {},
          "headerParametersUi": {
            "parameter": [
              {
                "name": "x-api-key",
                "value": "={{ $vars.EDUCARE_API_KEY }}"
              }
            ]
          },
          "queryParametersUi": {
            "parameter": [
              {
                "name": "weeks",
                "value": "={{ $input.item.json.current_week }}"
              }
            ]
          }
        },
        "id": "fcdb2bd2-6c01-446d-b770-f95f8c377da2",
        "name": "API: Mother Content",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          0,
          128
        ]
      },
      {
        "parameters": {
          "jsCode": "// Prepara resposta unificada para roteamento de saÃ­da\n// v2.0 â€” Phase 2 fix: removed Merge: Unified Data references\nconst item = $input.item;\n\n// Recuperar dados do extractor ativo nesta execuÃ§Ã£o\nlet extractorData = {};\ntry { extractorData = $('Chatwoot Extractor').item.json; } catch(e) {\n  try { extractorData = $('Evolution Extractor').item.json; } catch(e2) {\n    extractorData = {};\n  }\n}\n\nconst source = item.json.source || extractorData.source || 'evolution';\nconst responseText = item.json.response_text || item.json.answer || item.json.message || 'Mensagem recebida!';\nconst mediaType = item.json.media_type || 'text';\n\nreturn [{\n  json: {\n    ...item.json,\n    source,\n    response_text: responseText,\n    media_type: mediaType,\n    phone: item.json.phone || extractorData.phone,\n    conversation_id: item.json.conversation_id || extractorData.conversation_id || null,\n    inbox_id: item.json.inbox_id || extractorData.inbox_id || null,\n    account_id: item.json.account_id || extractorData.account_id || null\n  }\n}];"
        },
        "id": "d52f2243-68b7-4dca-affa-b8a393686db3",
        "name": "Prepare Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 1,
        "position": [
          304,
          272
        ],
        "notes": "Prepara dados unificados para resposta"
      },
      {
        "parameters": {
          "dataType": "string",
          "value1": "={{ $json.source }}",
          "rules": {
            "rules": [
              {
                "value2": "chatwoot"
              },
              {
                "value2": "evolution",
                "output": 1
              }
            ]
          },
          "fallbackOutput": 1
        },
        "id": "90a64423-8f62-4de5-9897-22edc5fc39c4",
        "name": "Router: Response Source",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 1,
        "position": [
          432,
          448
        ],
        "notes": "Roteia resposta para Chatwoot ou Evolution API"
      },
      {
        "parameters": {
          "url": "={{ $vars.CHATWOOT_API_URL }}/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
          "options": {},
          "requestMethod": "POST",
          "sendBody": true,
          "contentType": "json",
          "bodyParametersUi": {
            "parameter": [
              {
                "name": "content",
                "value": "={{ $json.response_text }}"
              },
              {
                "name": "message_type",
                "value": "outgoing"
              },
              {
                "name": "content_type",
                "value": "text"
              }
            ]
          },
          "headerParametersUi": {
            "parameter": [
              {
                "name": "api_access_token",
                "value": "={{ $vars.CHATWOOT_API_TOKEN || '' }}"
              }
            ]
          }
        },
        "id": "d88f2d2a-1a71-4139-ada0-a8d02e597a02",
        "name": "Chatwoot: Send Text",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          560,
          288
        ],
        "notes": "Envia resposta de texto via Chatwoot API"
      },
      {
        "parameters": {
          "dataType": "string",
          "value1": "={{ $json.media_type || 'text' }}",
          "rules": {
            "rules": [
              {
                "value2": "text"
              },
              {
                "value2": "image",
                "output": 1
              },
              {
                "value2": "audio",
                "output": 2
              },
              {
                "value2": "document",
                "output": 3
              }
            ]
          },
          "fallbackOutput": 0
        },
        "id": "26db85f2-f552-499e-a009-b70c1b7ea1c2",
        "name": "Router: Evo Output Type",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 1,
        "position": [
          656,
          432
        ],
        "notes": "Roteia resposta Evolution baseado no tipo de mÃ­dia"
      },
      {
        "parameters": {
          "url": "={{ $vars.EVOLUTION_API_URL }}/message/sendText/{{ $vars.EVOLUTION_INSTANCE }}",
          "options": {},
          "requestMethod": "POST",
          "sendBody": true,
          "contentType": "json",
          "bodyParametersUi": {
            "parameter": [
              {
                "name": "number",
                "value": "={{ $json.phone }}"
              },
              {
                "name": "text",
                "value": "={{ $json.response_text }}"
              }
            ]
          },
          "headerParametersUi": {
            "parameter": [
              {
                "name": "apikey",
                "value": "={{ $vars.EVOLUTION_API_KEY || '' }}"
              }
            ]
          }
        },
        "id": "a6fb2c65-4170-4c1a-8cf9-e799af45a472",
        "name": "Evo: Send Text",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          960,
          144
        ]
      },
      {
        "parameters": {
          "url": "={{ $vars.EVOLUTION_API_URL }}/message/sendMedia/{{ $vars.EVOLUTION_INSTANCE }}",
          "options": {},
          "requestMethod": "POST",
          "sendBody": true,
          "contentType": "json",
          "bodyParametersUi": {
            "parameter": [
              {
                "name": "number",
                "value": "={{ $json.phone }}"
              },
              {
                "name": "mediatype",
                "value": "image"
              },
              {
                "name": "media",
                "value": "={{ $json.media_url }}"
              },
              {
                "name": "caption",
                "value": "={{ $json.response_text }}"
              }
            ]
          },
          "headerParametersUi": {
            "parameter": [
              {
                "name": "apikey",
                "value": "={{ $vars.EVOLUTION_API_KEY || '' }}"
              }
            ]
          }
        },
        "id": "79a7281c-9d55-41ca-8b1a-530f3c4793a8",
        "name": "Evo: Send Image",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          960,
          336
        ]
      },
      {
        "parameters": {
          "url": "={{ $vars.EVOLUTION_API_URL }}/message/sendWhatsAppAudio/{{ $vars.EVOLUTION_INSTANCE }}",
          "options": {},
          "requestMethod": "POST",
          "sendBody": true,
          "contentType": "json",
          "bodyParametersUi": {
            "parameter": [
              {
                "name": "number",
                "value": "={{ $json.phone }}"
              },
              {
                "name": "audio",
                "value": "={{ $json.media_url }}"
              }
            ]
          },
          "headerParametersUi": {
            "parameter": [
              {
                "name": "apikey",
                "value": "={{ $vars.EVOLUTION_API_KEY || '' }}"
              }
            ]
          }
        },
        "id": "07d71687-6614-4859-a05f-63135dc2828f",
        "name": "Evo: Send Audio",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          976,
          544
        ]
      },
      {
        "parameters": {
          "url": "={{ $vars.EVOLUTION_API_URL }}/message/sendMedia/{{ $vars.EVOLUTION_INSTANCE }}",
          "options": {},
          "requestMethod": "POST",
          "sendBody": true,
          "contentType": "json",
          "bodyParametersUi": {
            "parameter": [
              {
                "name": "number",
                "value": "={{ $json.phone }}"
              },
              {
                "name": "mediatype",
                "value": "document"
              },
              {
                "name": "media",
                "value": "={{ $json.media_url }}"
              },
              {
                "name": "caption",
                "value": "={{ $json.response_text }}"
              }
            ]
          },
          "headerParametersUi": {
            "parameter": [
              {
                "name": "apikey",
                "value": "={{ $vars.EVOLUTION_API_KEY || '' }}"
              }
            ]
          }
        },
        "id": "4e10b0e0-a80f-402a-a2e8-dcc4ebb3e80a",
        "name": "Evo: Send Document",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 1,
        "position": [
          976,
          768
        ]
      },
      {
        "parameters": {
          "jsCode": "const item = $input.item;\nconst ref = $('Chatwoot Extractor').item.json;\n\nconst escapeMarkdown = (text = '') => text.replace(/([_*~])/g, '\\\\$1');\n\nconst phone = String(ref.phone || '');\nconst message = ref.message || '';\nconst media_type = ref.media_type || 'text';\nconst media_url = ref.media_url || null;\nconst is_audio = String(ref.is_audio || false);\nconst source_id = ref.source_id || null;\nconst timestamp = ref.timestamp || Date.now();\n\nconst conversation_id = String(ref.conversation_id || '');\nconst inbox_id = String(ref.inbox_id || '');\nconst account_id = String(ref.account_id || '');\nconst contact_id = String(ref.contact_id || '');\nconst sender_name_raw = ref.sender_name || '';\nconst sender_name = sender_name_raw.trim() || 'mamÃ£e/papai';\nconst safe_sender_name = escapeMarkdown(sender_name);\n\nconst thumbnail = ref.raw?.sender?.thumbnail ?? null;\nconst account_name = ref.raw?.account?.name ?? 'Educare+';\nconst inbox_name = ref.raw?.inbox?.name ?? 'WhatsApp';\n\nconst response_text = `Oi, ${safe_sender_name}! ðŸ‘‹\n\nNotei que vocÃª ainda nÃ£o tem uma conta ativa no app *${account_name}*. Com ele, vocÃª acompanha vacinas, consultas, fases do bebÃª, tudo com muito carinho e praticidade. ðŸ‘¶âœ¨\n\nðŸ’™ Que tal experimentar o app gratuitamente?\n\nðŸ“² Baixe agora: https://educareapp.com.br/app\n\nSe preferir, posso te ajudar por aqui no WhatsApp (${inbox_name}) tambÃ©m!`;\n\nreturn [{\n  json: {\n    phone,\n    message,\n    media_type,\n    media_url,\n    is_audio,\n    source_id,\n    timestamp,\n    conversation_id,\n    inbox_id,\n    account_id,\n    contact_id,\n    sender_name,\n    thumbnail,\n    source: 'chatwoot',\n    response_text,\n    user_found: false,\n    lead_status: 'novo'\n  }\n}];"
        },
        "id": "873f7608-c956-4d1f-9140-151357602a33",
        "name": "Prepare: No User Msg",
        "type": "n8n-nodes-base.code",
        "typeVersion": 1,
        "position": [
          -1184,
          784
        ]
      },
      {
        "parameters": {
          "jsCode": "// Prepara mensagem para usuÃ¡rios com assinatura inativa\n// v2.0 â€” Phase 2 fix: removed Merge: Unified Data references\nconst base = $input.item.json;\n\n// Recuperar dados do extractor ativo nesta execuÃ§Ã£o\nlet extractorData = {};\ntry { extractorData = $('Chatwoot Extractor').item.json; } catch(e) {\n  try { extractorData = $('Evolution Extractor').item.json; } catch(e2) {\n    extractorData = {};\n  }\n}\n\nconst phone = base.phone || extractorData.phone || '';\n\nreturn [{\n  json: {\n    channel: base.source || extractorData.source || 'evolution',\n    source: base.source || extractorData.source || 'evolution',\n    message_id: base.message_id || base.id || String(base.timestamp || $execution.id),\n    phone,\n    text: base.text || base.message || base.body || '',\n    user: {\n      user_id: base.user_id || (base.user ? (base.user.id || base.user.user_id) : undefined),\n      name: base.user_name || (base.user ? base.user.name : '') || '',\n      subscription_status: base.subscription_status || (base.user ? base.user.subscription_status : '') || 'inactive',\n      stripe_customer_id: base.stripe_customer_id || (base.user ? base.user.stripe_customer_id : '') || '',\n      stripe_checkout_url: base.stripe_checkout_url || ''\n    },\n    ctx: {\n      locale: base.locale || 'pt-BR',\n      campaign_id: base.campaign_id || 'inactive_reactivation_v1',\n      conversation_id: extractorData.conversation_id || null,\n      inbox_id: extractorData.inbox_id || null,\n      account_id: extractorData.account_id || null\n    }\n  }\n}];"
        },
        "id": "f594a78d-d93c-494f-88d5-73c49cefd846",
        "name": "Prepare: Inactive Msg",
        "type": "n8n-nodes-base.code",
        "typeVersion": 1,
        "position": [
          -960,
          768
        ]
      },
      {
        "parameters": {
          "content": "ValidaÃ§Ã£o de usuÃ¡rio, classificaÃ§Ã£o, e  descarte de mensagem geradas por agentes. Ou atualizaÃ§Ãµes do chatwoot ou evolution.",
          "height": 480,
          "width": 1104
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -3728,
          496
        ],
        "id": "54cbb66f-6337-49bf-93b2-d952dae3b6d5",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "content": "Detecta o tipo de mensagem (texto, audio, etc.)",
          "height": 800,
          "width": 1040,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -2528,
          304
        ],
        "id": "bd7fd420-7656-4601-9703-a57a116e5c82",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "resource": "audio",
          "operation": "transcribe",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 2.1,
        "position": [
          -2208,
          384
        ],
        "id": "a15cb076-9a83-4d14-8662-7e047eb06203",
        "name": "Transcribe a recording",
        "credentials": {
          "openAiApi": {
            "id": "gddH24JwjrAV57aC",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "8d59441a-8a58-4dae-8bad-8477b148786b",
                "name": "phone",
                "value": "={{$json.phone}}",
                "type": "string"
              },
              {
                "id": "30ddb993-997d-4fa8-8418-c07c48f96624",
                "name": "name",
                "value": "={{$json.sender_name}}\n",
                "type": "string"
              },
              {
                "id": "a5077ce4-5e0c-4f3c-9785-de5c9d5b6b55",
                "name": "lastmessage",
                "value": "={{$json.message}}",
                "type": "string"
              },
              {
                "id": "168d7eff-bfd3-46fd-8112-10b795103105",
                "name": "media_type",
                "value": "={{$json.media_type}}",
                "type": "string"
              },
              {
                "id": "d1c66522-0cfa-48cb-9918-f7f20c97a8ed",
                "name": "media_url",
                "value": "={{$json.media_url}}",
                "type": "string"
              },
              {
                "id": "32f49946-61b4-4c0b-8ecb-dfa927849f6c",
                "name": "is_audio",
                "value": "={{$json.is_audio}}",
                "type": "boolean"
              },
              {
                "id": "b4e529ad-2ec8-419d-bc4c-6fd3d2f0072d",
                "name": "source",
                "value": "={{$json.source}}",
                "type": "string"
              },
              {
                "id": "dd0c314f-ae01-4c71-a102-ce9a5c3d0708",
                "name": "source_id",
                "value": "={{$json.source_id}}",
                "type": "string"
              },
              {
                "id": "5e264e66-8654-4623-97b8-feba01a06db5",
                "name": "timestamp",
                "value": "={{$json.timestamp}}",
                "type": "number"
              },
              {
                "id": "864ea5bf-be3e-4764-a38d-4447b29cb624",
                "name": "conversation_id",
                "value": "={{$json.conversation_id}}",
                "type": "string"
              },
              {
                "id": "937ef3c0-a6de-4b81-ab7c-3db3e0772eaa",
                "name": "inbox_id",
                "value": "={{ $json.inbox_id }}",
                "type": "string"
              },
              {
                "id": "ec2a4fb8-d54c-4b1c-8439-9543164520ce",
                "name": "account_id",
                "value": "={{ $json.account_id }}",
                "type": "string"
              },
              {
                "id": "6408684e-59ac-43f7-a2e9-5aea4a5030e4",
                "name": "contact_id",
                "value": "={{ $json.contact_id }}",
                "type": "string"
              },
              {
                "id": "ccefef9e-50db-4a5e-941f-afb9fed2643e",
                "name": "sender_name",
                "value": "={{ $json.sender_name }}",
                "type": "string"
              },
              {
                "id": "ea85d2fc-e888-4418-88c1-a90de65c08c9",
                "name": "thumbnail",
                "value": "={{ $json.thumbnail }}",
                "type": "string"
              },
              {
                "id": "c4083e63-e4fe-4313-aaa5-7909edb7c7db",
                "name": "lead_status",
                "value": "={{ $json.lead_status }}",
                "type": "string"
              },
              {
                "id": "6df6bcdd-63fc-4b16-99fb-a8b596a5b535",
                "name": "user_found",
                "value": "={{ $json.user_found }}",
                "type": "boolean"
              },
              {
                "id": "bbb87b09-5467-40d7-9fdf-8c2a84f67f50",
                "name": "response_text",
                "value": "={{ $json.response_text }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -1184,
          960
        ],
        "id": "b3c3bba5-51be-4b40-af77-96aa016f47b9",
        "name": "Edit Fields",
        "notes": "Dados para tratar leads"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "45663cbc-a1b9-46d2-9fa5-0d6b32039e88",
                "leftValue": "={{$json.is_human}}",
                "rightValue": "incoming",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -3696,
          672
        ],
        "id": "66fee6be-f9d6-442a-977b-d56a5ef973c7",
        "name": "Ã‰ humano?"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -960,
          976
        ],
        "id": "00fa1dae-5a2c-47f7-b5d9-65d75077617c",
        "name": "Edit Fields1"
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "jGZCuPWlkZa8v9OB",
            "mode": "list",
            "cachedResultUrl": "/workflow/jGZCuPWlkZa8v9OB",
            "cachedResultName": "SUB | Inactive User Reactivation (WhatsApp + Stripe + PG Memory)"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "thisFieldAcceptsAnyType": "={{$json}}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "aField",
                "displayName": "aField",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": true
              },
              {
                "id": "aNumber",
                "displayName": "aNumber",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "number",
                "removed": true
              },
              {
                "id": "thisFieldAcceptsAnyType",
                "displayName": "thisFieldAcceptsAnyType",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "anArray",
                "displayName": "anArray",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "array",
                "removed": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.3,
        "position": [
          -736,
          976
        ],
        "id": "12f082d0-0412-4824-b7c6-4767c3e1b1d4",
        "name": "Call 'Agente Lead - long memory'1"
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "n6ZpQvp96iPCaIvG",
            "mode": "list",
            "cachedResultUrl": "/workflow/n6ZpQvp96iPCaIvG",
            "cachedResultName": "Lead CRM"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "thisFieldAcceptsAnyType": "={{$json}}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "aField",
                "displayName": "aField",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": true
              },
              {
                "id": "aNumber",
                "displayName": "aNumber",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "number",
                "removed": true
              },
              {
                "id": "thisFieldAcceptsAnyType",
                "displayName": "thisFieldAcceptsAnyType",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "anArray",
                "displayName": "anArray",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "array",
                "removed": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.3,
        "position": [
          -1168,
          1168
        ],
        "id": "14fd7168-4324-463f-8d7a-19f617a6b4b3",
        "name": "Call 'Agente Lead'"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-globals.globalConstants",
        "typeVersion": 1,
        "position": [
          -1856,
          624
        ],
        "id": "8cdeb497-286a-4d70-bae7-756e8c68eb99",
        "name": "Global Constants",
        "alwaysOutputData": true,
        "credentials": {
          "globalConstantsApi": {
            "id": "I0U483eFAXTruzVB",
            "name": "Global Constants account"
          }
        }
      }
    ],
    "connections": {
      "Webhook (Unified Entry)": {
        "main": [
          [
            {
              "node": "Source Detector",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Source Detector": {
        "main": [
          [
            {
              "node": "Ã‰ humano?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Router: Source Type": {
        "main": [
          [
            {
              "node": "Chatwoot Extractor",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Evolution Extractor",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Chatwoot Extractor": {
        "main": [
          [
            {
              "node": "Gate: Not Skipped?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Evolution Extractor": {
        "main": [
          [
            {
              "node": "Gate: Not Skipped?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Gate: Not Skipped?": {
        "main": [
          [
            {
              "node": "Router: Input Type",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Router: Input Type": {
        "main": [
          [
            {
              "node": "Transcribe a recording",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Global Constants",
              "type": "main",
              "index": 0
            }
          ],
          []
        ]
      },
      "Normalize Audio": {
        "main": [
          [
            {
              "node": "Global Constants",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Check User": {
        "main": [
          [
            {
              "node": "Gate: User Exists?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Gate: User Exists?": {
        "main": [
          [
            {
              "node": "Gate: Active Sub?",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Prepare: No User Msg",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Gate: Active Sub?": {
        "main": [
          [
            {
              "node": "Engine: Calc Weeks",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Prepare: Inactive Msg",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare: No User Msg": {
        "main": [
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare: Inactive Msg": {
        "main": [
          [
            {
              "node": "Edit Fields1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Engine: Calc Weeks": {
        "main": [
          [
            {
              "node": "Intent Classifier",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Router: Intent Switch": {
        "main": [
          [
            {
              "node": "Router: Menu Options",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: Biometrics",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: Sleep Log",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: Vaccines",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: RAG (TitiNauta)",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: Appointments",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Router: Menu Options": {
        "main": [
          [
            {
              "node": "API: Child Content",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: Mother Content",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: Vaccines",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: RAG (TitiNauta)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Biometrics": {
        "main": [
          [
            {
              "node": "Prepare Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Sleep Log": {
        "main": [
          [
            {
              "node": "Prepare Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Vaccines": {
        "main": [
          [
            {
              "node": "Prepare Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: RAG (TitiNauta)": {
        "main": [
          [
            {
              "node": "Prepare Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Appointments": {
        "main": [
          [
            {
              "node": "Prepare Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Child Content": {
        "main": [
          [
            {
              "node": "Prepare Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Mother Content": {
        "main": [
          [
            {
              "node": "Prepare Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Response": {
        "main": [
          [
            {
              "node": "Router: Response Source",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Router: Response Source": {
        "main": [
          [
            {
              "node": "Chatwoot: Send Text",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Router: Evo Output Type",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Router: Evo Output Type": {
        "main": [
          [
            {
              "node": "Evo: Send Text",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Evo: Send Image",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Evo: Send Audio",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Evo: Send Document",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Transcribe a recording": {
        "main": [
          [
            {
              "node": "Normalize Audio",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          [
            {
              "node": "Call 'Agente Lead'",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Ã‰ humano?": {
        "main": [
          [
            {
              "node": "Router: Source Type",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields1": {
        "main": [
          [
            {
              "node": "Call 'Agente Lead - long memory'1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Global Constants": {
        "main": [
          [
            {
              "node": "API: Check User",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Intent Classifier": {
        "main": [
          [
            {
              "node": "Router: Intent Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Derik Silva",
    "name": null,
    "description": null,
    "autosaved": false
  }
}